<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>MP3テストライブラリ</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        #container {
            width: 800px;
            border: 1px solid #ccc;
            padding: 20px;
            border-radius: 5px;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .section {
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .section h2 {
            margin-top: 0;
        }

        #fileInput {
            margin-bottom: 10px;
        }

        #audio {
            width: 100%;
            margin-bottom: 10px;
        }

        #waveform {
            width: 100%;
            height: 100px;
            background-color: #f0f0f0;
            margin-bottom: 10px;
        }

        #info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        #key-info,
        #bpm-info {
            font-size: 18px;
        }

        .key-container {
            display: flex;
            width: 100%;
            height: 50px;
            margin-bottom: 10px;
        }

        .key-bar {
            flex-grow: 1;
            height: 100%;
            background-color: #ccc;
            margin-right: 2px;
            border-radius: 5px;
            transition: background-color 0.2s ease;
        }

        .key-bar.active {
            background-color: #f00;
        }

        #json-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #json-output {
            width: 100%;
            height: 100px;
            margin-bottom: 10px;
            resize: vertical;
        }

        #loading-bar {
            width: 0%;
            height: 5px;
            background-color: #4CAF50;
            margin-bottom: 10px;
            transition: width 0.5s ease;
        }

        #instrument-select {
            margin-bottom: 10px;
        }
    </style>
</head>

<body>

    <div id="container">
        <h1>MP3テストライブラリ</h1>

        <div class="section">
            <h2>ファイル選択</h2>
            <input type="file" id="fileInput" accept="audio/mpeg">
            <audio id="audio" controls></audio>
        </div>

        <div class="section">
            <h2>波形表示</h2>
            <canvas id="waveform"></canvas>
        </div>

        <div class="section">
            <h2>情報</h2>
            <div id="info">
                <div id="key-info">キー: <span id="key-value">検出中...</span></div>
                <div id="bpm-info">BPM: <input type="number" id="bpm-input" value="120"> <span
                        id="bpm-value">自動検出</span></div>
            </div>
        </div>

        <div class="section">
            <h2>キー強度</h2>
            <div class="key-container" id="waveform-key">
            </div>
        </div>

        <div class="section">
            <h2>楽器選択</h2>
            <select id="instrument-select">
                <option value="sine">Sine</option>
                <option value="square">Square</option>
                <option value="sawtooth">Sawtooth</option>
                <option value="triangle">Triangle</option>
            </select>
        </div>

        <div class="section">
            <h2>JSONデータ</h2>
            <div id="json-container">
                <textarea id="json-output" readonly></textarea>
                <button id="copy-json">JSONをコピー</button>
                <input type="file" id="load-json-file" accept=".json">
                <div id="loading-bar"></div>
                <button id="play-json">JSONを再生</button>
            </div>
        </div>
        <div id="sheet-music" style="display: none;"></div>
    </div>

    <script>
        const fileInput = document.getElementById('fileInput');
        const audio = document.getElementById('audio');
        const canvas = document.getElementById('waveform');
        const ctx = canvas.getContext('2d');
        const keyValue = document.getElementById('key-value');
        const bpmValue = document.getElementById('bpm-value');
        const bpmInput = document.getElementById('bpm-input');
        const waveformKeyContainer = document.getElementById('waveform-key');
        const jsonOutput = document.getElementById('json-output');
        const copyJsonButton = document.getElementById('copy-json');
        const loadJsonFile = document.getElementById('load-json-file');
        const playJsonButton = document.getElementById('play-json');
        const loadingBar = document.getElementById('loading-bar');
        const instrumentSelect = document.getElementById('instrument-select');
        


        const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
        const keyFrequencies = notes.map((note, index) => 440 * Math.pow(2, (index - 9) / 12));

        let audioCtx, source, analyser, bufferLength, dataArray;
        let onsets = [];
        let bpm;
        let lastBeatTime = 0;
        let isPlaying = false;

        let sheetMusicContainer = document.getElementById('sheet-music');
        let animationId;

        let onAudioPlay, onAudioPause;

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.onload = (e) => {
                audio.src = e.target.result;
                audio.load();

                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                source = audioCtx.createMediaElementSource(audio);
                analyser = audioCtx.createAnalyser();

                source.connect(analyser);
                analyser.connect(audioCtx.destination);

                analyser.fftSize = 2048;
                bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);

                waveformKeyContainer.innerHTML = '';
                for (let i = 0; i < notes.length; i++) {
                    const bar = document.createElement('div');
                    bar.classList.add('key-bar');
                    bar.style.height = '0px';
                    waveformKeyContainer.appendChild(bar);
                }

                sheetMusicContainer = document.getElementById('sheet-music');
                sheetMusicContainer.innerHTML = '';

                audio.removeEventListener('play', onAudioPlay);
                audio.removeEventListener('pause', onAudioPause);

                onAudioPlay = () => {
                    isPlaying = true;
                    lastBeatTime = audioCtx.currentTime;
                    onsets = [];
                    draw();
                };
                onAudioPause = () => {
                    isPlaying = false;
                    cancelAnimationFrame(animationId);
                };

                audio.addEventListener('play', onAudioPlay);
                audio.addEventListener('pause', onAudioPause);

                draw();

            };

            reader.readAsDataURL(file);
        });

        function draw() {
            if (!isPlaying) return;

            animationId = requestAnimationFrame(draw);

            analyser.getByteTimeDomainData(dataArray);

            bpm = parseInt(bpmInput.value, 10);
            bpmValue.textContent = bpm;

            const onsetDetectionThreshold = 0.3;

            let instantEnergy = 0;
            for (let i = 0; i < bufferLength; i++) {
                instantEnergy += dataArray[i] * dataArray[i];
            }
            instantEnergy /= bufferLength;

            if (instantEnergy > onsetDetectionThreshold) {
                onsets.push(audioCtx.currentTime);

                if (onsets.length > 2) {
                    const intervals = [];
                    for (let i = 1; i < onsets.length; i++) {
                        intervals.push(onsets[i] - onsets[i - 1]);
                    }

                    if (bpm) {
                        const noteIndex = Math.floor(Math.random() * notes.length);
                        const note = notes[noteIndex];
                        const beatInterval = 60 / bpm;
                        const duration = quantizeDuration(intervals[intervals.length - 1] / beatInterval, beatInterval);
                        const time = onsets[onsets.length - 1];
                        const velocity = Math.round(instantEnergy * 127); // 音量をエネルギーから計算

                        lastBeatTime = time + (duration * beatInterval);

                        if (sheetMusicContainer) {
                            sheetMusicContainer.innerHTML += `<span data-note="${note}" data-duration="${duration}" data-time="${time}" data-velocity="${velocity}">${note} </span>`;

                            const sheetMusicData = Array.from(sheetMusicContainer.children).map(noteElement => ({
                                note: noteElement.dataset.note,
                                duration: parseFloat(noteElement.dataset.duration),
                                time: parseFloat(noteElement.dataset.time),
                                velocity: parseInt(noteElement.dataset.velocity) // velocityを追加
                            }));
                            const jsonData = JSON.stringify({
                                bpm: bpm,
                                sheetMusic: sheetMusicData
                            }, null, 2);
                            jsonOutput.value = jsonData;
                        }

                        onsets.shift();
                    }
                }
            }

            ctx.fillStyle = '#f0f0f0';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.lineWidth = 1;
            ctx.strokeStyle = 'black';

            ctx.beginPath();

            const sliceWidth = canvas.width * 1.0 / bufferLength;
            let x = 0;

            for (let i = 0; i < bufferLength; i++) {
                const v = dataArray[i] / 128.0;
                const y = v * canvas.height / 2 + canvas.height / 2;

                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            ctx.stroke();

            const keyStrengths = keyFrequencies.map(frequency => {
                const index = Math.round(frequency / audioCtx.sampleRate * bufferLength);
                return dataArray[index];
            });

            const strongestKeyIndex = keyStrengths.indexOf(Math.max(...keyStrengths));
            const strongestKey = notes[strongestKeyIndex];

            keyValue.textContent = strongestKey;

            const bars = waveformKeyContainer.querySelectorAll('.key-bar');
            bars.forEach((bar, index) => {
                const strength = keyStrengths[index];
                bar.style.height = strength + 'px';
                bar.classList.toggle('active', index === strongestKeyIndex);
            });
        }

        function quantizeDuration(duration, beatInterval) {
            const quantizedDurations = [0.25, 0.5, 1, 2];
            let minDiff = Infinity;
            let closestDuration = 0.25;

            for (const quantizedDuration of quantizedDurations) {
                const diff = Math.abs(duration - quantizedDuration * beatInterval);
                if (diff < minDiff) {
                    minDiff = diff;
                    closestDuration = quantizedDuration;
                }
            }

            return closestDuration;
        }

        function copyJsonToClipboard() {
            jsonOutput.select();
            document.execCommand('copy');
            alert('JSONをクリップボードにコピーしました。');
        }

        function downloadJsonFile() {
            const jsonData = jsonOutput.value;
            const blob = new Blob([jsonData], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sheet_music.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function loadSheetMusicFromJson(jsonData) {
            const data = JSON.parse(jsonData);
            bpmValue.textContent = data.bpm;
            sheetMusicContainer.innerHTML = '';
            data.sheetMusic.forEach(noteData => {
                const noteElement = document.createElement('span');
                noteElement.textContent = noteData.note + " ";
                noteElement.dataset.note = noteData.note;
                noteElement.dataset.duration = noteData.duration;
                noteElement.dataset.velocity = noteData.velocity; // velocityをdatasetに追加
                sheetMusicContainer.appendChild(noteElement);
            });

            jsonOutput.value = JSON.stringify(data, null, 2);
        }

        function playSheetMusicFromJson(jsonData) {
            const data = JSON.parse(jsonData);
            bpm = data.bpm; // グローバル変数のbpmを更新
            bpmValue.textContent = bpm;

            const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            data.sheetMusic.forEach(noteData => {
                const oscillator = audioCtx.createOscillator();
                oscillator.type = instrumentSelect.value; // 選択された楽器を設定
                oscillator.frequency.value = getFrequencyFromNote(noteData.note);

                const gainNode = audioCtx.createGain();
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime + noteData.time);
                gainNode.gain.linearRampToValueAtTime(noteData.velocity / 127, audioCtx.currentTime + noteData.time + 0.01); // velocityをgainに反映
                gainNode.gain.linearRampToValueAtTime(0, audioCtx.currentTime + noteData.time + noteData.duration - 0.01);

                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);

                oscillator.start(audioCtx.currentTime + noteData.time);
                oscillator.stop(audioCtx.currentTime + noteData.time + noteData.duration);
            });
        }

        function getFrequencyFromNote(note) {
            const noteIndex = notes.indexOf(note);
            if (noteIndex === -1) {
                return 440;
            }
            return 440 * Math.pow(2, (noteIndex - 9) / 12);
        }

        copyJsonButton.addEventListener('click', copyJsonToClipboard);
        copyJsonButton.addEventListener('click', downloadJsonFile);

        loadJsonFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            const reader = new FileReader();

            loadingBar.style.width = '0%';
            loadingBar.style.backgroundColor = '#4CAF50';

            reader.onloadstart = () => {
                loadingBar.style.display = 'block';
            };

            reader.onprogress = (event) => {
                if (event.lengthComputable) {
                    const percentLoaded = Math.round((event.loaded / event.total) * 100);
                    loadingBar.style.width = percentLoaded + '%';
                }
            };

            reader.onload = (e) => {
                const jsonData = e.target.result;
                loadSheetMusicFromJson(jsonData);

                loadingBar.style.width = '100%';
                loadingBar.style.backgroundColor = '#008CBA';
                setTimeout(() => {
                    loadingBar.style.display = 'none';
                }, 500);
            };

            reader.onerror = () => {
                loadingBar.style.backgroundColor = '#f44336';
                alert('JSONファイルの読み込みに失敗しました。');
            };

            reader.readAsText(file);
        });

        playJsonButton.addEventListener('click', () => {
            const jsonData = jsonOutput.value;
            if (jsonData) {
                playSheetMusicFromJson(jsonData);
            }
        });
    </script>
</body>

</html>